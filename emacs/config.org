#+TITLE: Emacs configuration
#+DESCRIPTION: Emacs configuration is written in orgmode. Code is directly written to the files using org-babel-tangle without the need to start orgmode at startup.
#+PROPERTY: header-args :lexical t :tangle "init.el" :mkdirp "lisp"
#+STARTUP: showeverything  hidestars

* Early-init
=Early-init= made for speed up Emacs.

#+BEGIN_SRC elisp :tangle "early-init.el"
;; early-init.el -*- lexical-binding: t; -*-

;; Increase 'gc-cons-threshold' to 100MB for lsp heavy buffers.
(setq gc-cons-threshold 100000000)

;; Handle large chunks of process output, improving peroformence of external processes (like LSP servers)
(setq read-process-output-max (* 1024 1024)) ;; 1 MB

(setq load-path-filter-function #'load-path-filter-cache-directory-files)

(setq corfu-debug t)
(setq eglot-events-buffer-size 2000000)  ; Increase for debugging

;; Tree-sitter performence enchancement
(setenv "LSP_USE_PLISTS" "true")
(setq lsp-use-plists t)

;; Disable "file-name-handler-alist" than enable it later for speed.
(defvar startup/file-name-handler-alist file-name-handler-alist)
(setq file-name-handler-alist nil)
(add-hook 'emacs-startup-hook
          (lambda ()
            (setq file-name-handler-alist startup/file-name-handler-alist)
            (makunbound 'startup/file-name-handler-alist)))

;; Speed up package loading
(setq package-quickstart t)

;; Loads packages only when needed
(setq use-package-always-defer t)
#+END_SRC

** Disable menu and scrollbar
#+BEGIN_SRC elisp :tangle "early-init.el"
(tool-bar-mode -1)
(menu-bar-mode -1)
(tooltip-mode -1)
(scroll-bar-mode -1)
(horizontal-scroll-bar-mode -1)
(global-tab-line-mode -1) ; tab line
(tab-bar-mode -1) ; tabs
(global-visual-line-mode t) ; don't let the text to go horizontal.
(global-hl-line-mode t) ; highlight the line you're on.
(global-display-line-numbers-mode t) ; Slow down with big files.
(electric-pair-mode t) ;; auto brackets.
(electric-indent-mode -1)
                                        ;(blink-cursor-mode -1)
                                        ;(desktop-save-mode 1)
#+END_SRC

** Remeber last place you were in file.
#+BEGIN_SRC elisp :tangle "early-init.el"
(save-place-mode 1)
#+END_SRC

** Auto revert buffer for changed files.
#+BEGIN_SRC elisp :tangle "early-init.el"
(global-auto-revert-mode t)
#+END_SRC

** Auto revert dired buffer

#+BEGIN_SRC elisp :tangle "early-init.el"
(setq global-auto-revert-non-file-buffers t)
#+END_SRC
** Open Emacs in full screen always.

#+BEGIN_SRC elisp :tangle "early-init.el"
(add-to-list 'default-frame-alist '(fullscreen . maximized))
#+END_SRC

** Preventing flickering.
#+begin_src elisp :tangle "early-init.el"
(add-to-list 'default-frame-alist '(inhibit-double-buffering . t))
#+end_src

** Show parenthesis.
#+BEGIN_SRC elisp :tangle "early-init.el"
(setq show-paren-style 'expression)
(show-paren-mode 1)
(set-face-background 'show-paren-match (face-background 'default))
(set-face-foreground 'show-paren-match "#def")
(custom-set-faces
 '(show-paren-match ((t (:weight extra-bold)))))
#+END_SRC

** UTF
#+BEGIN_SRC elisp :tangle "early-init.el"
(prefer-coding-system 'utf-8)
(set-default-coding-systems 'utf-8)
(set-terminal-coding-system 'utf-8)
(set-keyboard-coding-system 'utf-8)
#+END_SRC

** Major settings
#+BEGIN_SRC elisp :tangle "early-init.el"
(setq
 display-line-numbers-width nil
 package-enable-at-startup nil ; don't auto-initialize!
 package-enable-imenu-support t
 package--init-file-ensured t ; don't add that `custom-set-variables' block to init
 package-archives nil
 load-prefer-newer t ; prefer newer package files.
 frame-resize-pixelwise t
 visible-bell 1 ; Alarm bell (flash the bar)

 ;; Tab behaviour
 completion-cycle-threshold 3 ;; TAB cycle if there are only few candidates
 tab-always-indent 'complete ;; Enable indentation+completion using the TAB key.
 tab-line-new-button-show nil
 echo-keystrokes 0.01 ;; decrease the echoing of the keystrokes.

 ;; Tab line
 tab-line-close-button-show nil
 tab-line-separator " "
 line-move-visual nil
 site-run-file nil ; unset SRF
 ;; scroll
 pixel-scroll-precision-mode t
 pixel-scroll-precision-use-momentum t
 scroll-conservatively 101 ;; scroll line by line.

 use-file-dialog nil
 mode-line-format nil ; don't want a mode line while loading init
 create-lockfiles nil ; disable lockfiles
 make-backup-files nil ; disable backup file
 backup-directory-alist '((".*" . "~/.local/share/Trash/files"))

 ;; Disable auto save alltogether.
 auto-save-list-file-prefix nil ; disable auto-save
 auto-save-default nil
 auto-save-mode nil
 delete-auto-save-files t ; delete auto save files

 auto-mode-case-fold nil ; use case-sensitive `auto-mode-alist' for performance
 default-input-method nil
 utf-translate-cjk-mode nil ; disable CJK coding/encoding (Chinese/Japanese/Korean characters)
 initial-scratch-message nil ; empty the initial *scratch* buffer.
 message-log-max nil
 command-line-x-option-alist nil ; remove irreleant command line options for faster startup
 use-short-answers t ; y/n for yes/no
 vc-follow-symlinks t ; Do not ask about symlink following
 use-dialog-box nil
 inhibit-default-init t
 use-file-dialog nil
 redisplay-dont-pause t ; improve display engine

 ;; Suppress the startup
                                        ;inhibit-splash-screen t
                                        ;inhibit-startup-screen t		; do not show the startup message
                                        ;inhibit-startup-message t      ; reduce noise at startup
                                        ;inhibit-startup-buffer-menu t  ; stop `list-buffers' from showing when opening multiple files

 frame-inhibit-implied-resize t ; do not resize the frame at this early stage
 ffap-machine-p-known 'reject   ; don't ping things that look like domain names

 ;; Improve performance
 inhibit-compacting-font-caches t ; Inhibit frame resizing for performance
 read-process-output-max (* 1024 1024) ; Increase how much is read from processes in a single chunk.
 fast-but-imprecise-scrolling t ; more performant rapid scrolling over unfontified regions
 scroll-conservatively 101
 scroll-margin 0
 scroll-preserve-screen-position t

 redisplay-skip-fontification-on-input t ; Inhibits it for better scrolling performance.
 idle-update-delay 1.0 ; slow down UI updates down
 select-active-regions 'only ; Emacs hangs when large selections contain mixed line endings
 ad-redefinition-action 'accept ; disable warnings from legacy advice system
 initial-major-mode 'fundamental-mode
 confirm-kill-emacs 'y-or-n-p ; confirm before exiting emacs
 enable-local-variables :safe ; host security
 column-number-mode t
 org-indent-mode nil
 display-line-numbers-type 'relative
 custom-file (make-temp-file "emacs-custom-")
 enable-recursive-minibuffers t                ; Use the minibuffer whilst in the minibuffer
 completion-cycle-threshold 1                  ; TAB cycles candidates
 completions-detailed t                        ; Show annotations
 tab-always-indent 'complete                   ; When I hit TAB, try to complete, otherwise, indent
 completion-styles '(basic initials substring) ; Different styles to match input to candidates

 completion-auto-help 'always                  ; Open completion always; `lazy' another option
 completions-max-height 20                     ; This is arbitrary
 completions-detailed t
 completions-format 'one-column
 completions-group t
 completion-auto-select 'second-tab            ; Much more eager
 x-stretch-cursor nil


 ;; Vertical Scroll
 scroll-step 1
 scroll-margin 1
 scroll-conservatively 101
 scroll-up-aggressively 0.01
 scroll-down-aggressively 0.01
 auto-window-vscroll nil
 fast-but-imprecise-scrolling nil
 mouse-wheel-scroll-amount '(1 ((shift) . 1))
 mouse-wheel-progressive-speed nil
 ;; Horizontal Scroll
 hscroll-margin 2
 hscroll-step 1
 ;; Emacs spends too much effort recentering the screen if you scroll the
 ;; cursor more than N lines past window edges (where N is the settings of
 ;; `scroll-conservatively'). This is especially slow in larger files
 ;; during large-scale scrolling commands. If kept over 100, the window is
 ;; never automatically recentered. The default (0) triggers this too
 ;; aggressively, so I've set it to 10 to recenter if scrolling too far
 ;; off-screen.
 scroll-conservatively 101
 scroll-preserve-screen-position t
 scroll-margin 2
 scroll-preserve-screen-position t
 ;; Reduce cursor lag by a tiny bit by not auto-adjusting `window-vscroll'
 ;; for tall lines.
 auto-window-vscroll nil
 ;; mouse
 mouse-wheel-scroll-amount '(2 ((shift) . hscroll))
 mouse-wheel-scroll-amount-horizontal 2

 confirm-nonexistent-file-or-buffer nil

                                        ;  (setq-default isearch-lazy-count t)
 enable-recursive-minibuffers t
 kill-ring-max 100

                                        ; frame-title-format "E M A C S"

                                        ; browse-url-browser-function 'browse-url-xdg-open

                                        ; custom-safe-themes t

 native-comp-async-report-warnings-errors nil

 ;; Prevent unwanted runtime builds in gccemacs (native-comp); packages are
 ;; compiled ahead-of-time when they are installed and site files are compiled
 ;; when gccemacs is installed.
 comp-deferred-compilation nil

 ;; Compile all sites-lisp on demand.
 native-comp-jit-compilation t

 ;; Keep the eln cache clean.
 native-compile-prune-cache t

 ;; Solve slow icon rendering
 inhibit-compacting-font-caches t

 ;; Enable ibuffer
 ibuffer-expert t

 display-buffer-alist nil

 select-enable-clipboard t ;; Copy and Paste outside of Emacs
 )

(defalias 'yes-or-no-p 'y-or-n-p) ; yes or no to y or n
                                        ;  (add-hook 'prog--hook 'display-line-numbers-mode) ; Only use line-numbers in major modes
                                        ;  (add-hook 'text-mode-hook 'display-line-numbers-mode)
(windmove-default-keybindings)

;; Improve memory
(setq-default history-length 1000)
(setq-default prescient-history-length 1000)
#+END_SRC

** Fonts
#+BEGIN_SRC elisp :tangle "early-init.el"
;; Set base faces for all users
(custom-set-faces
 ;; Default font for all text
                                        ; '(default ((t (:family "JetBrains Mono" :height 90))))
                                        ;'(fixed-pitch ((t (:family "JetBrains Mono" :height 80))))

 ;; Current line number
 '(line-number-current-line ((t (:foreground "yellow" :inherit line-number))))
 '(mode-line ((t (:family "JetBrains Mono" :weight Bold))))

 ;; Comments italic
 ;; '(font-lock-comment-face ((t (:family "JetBrains Mono" :slant italic))))
 ;; ;;   ;; Keywords, functions, strings, etc. italic with no color change
 ;; '(font-lock-keyword-face ((t (:family "JetBrains Mono" :slant italic))))
 ;; '(font-lock-function-name-face ((t (:family "JetBrains Mono":slant italic))))
 ;; '(font-lock-string-face ((t (:family "JetBrains Mono" :slant italic))))
 ;; '(font-lock-variable-name-face ((t (:family "JetBrains Mono":weight bold))))
 ;; ;;   '(font-lock-constant-face ((t (:family "JetBrains Mono" :slant italic))))
 ;; ;;   '(font-lock-type-face ((t (:family "JetBrains Mono" :slant italic))))
 ;; ;;   '(font-lock-builtin-face ((t (:family "JetBrains Mono" :slant italic))))

 ;; `(font-lock-builtin-face ((t (:family "JetBrains Mono" :weight bold :slant italic))))
 ;;     `(font-lock-comment-face ((t (:family "JetBrains Mono" :slant italic))))
 ;;     `(font-lock-constant-face ((t (:family "JetBrains Mono" :weight bold))))
 ;;     `(font-lock-function-name-face ((t (:family "JetBrains Mono" :weight bold))))
 ;;     `(font-lock-keyword-face ((t (:family "JetBrains Mono" :weight bold :slant italic))))
 ;;     `(font-lock-string-face ((t (:family "JetBrains Mono" :slant italic))))
 ;;     `(font-lock-type-face ((t (:family "JetBrains Mono" :weight bold))))
 ;;     `(font-lock-variable-name-face ((t (:family "JetBrains Mono" :weight bold))))
 ;;     `(font-lock-warning-face ((t (:family "JetBrains Mono" :weight bold :underline t))))

 )

(when (string= (system-name) "WarMachine")
  (custom-set-faces
   '(default ((t (:family "JetBrains Mono" :height 100))))
   '(variable-pitch ((t (:family "Linux Libertine" :height 80))))
   '(fixed-pitch ((t (:family "JetBrains Mono" :height 90))))))

(when (string= (system-name) "Tiffany")
  (setq doom-modeline-height 20)
  (setq display-battery-mode nil)
  (custom-set-faces
   '(default ((t (:family "JetBrains Mono" :height 90))))
   '(variable-pitch ((t (:family "Linux Libertine" :height 80))))
   '(fixed-pitch ((t (:family "JetBrains Mono" :height 80))))))
#+end_src

* Package Management

** Straight
#+BEGIN_SRC elisp
;; init.el -*- lexical-binding: t; -*-
(defvar elpaca-installer-version 0.11)
(defvar elpaca-directory (expand-file-name "elpaca/" user-emacs-directory))
(defvar elpaca-builds-directory (expand-file-name "builds/" elpaca-directory))
(defvar elpaca-repos-directory (expand-file-name "repos/" elpaca-directory))
(defvar elpaca-order '(elpaca :repo "https://github.com/progfolio/elpaca.git"
                              :ref nil :depth 1 :inherit ignore
                              :files (:defaults "elpaca-test.el" (:exclude "extensions"))
                              :build (:not elpaca--activate-package)))
(let* ((repo  (expand-file-name "elpaca/" elpaca-repos-directory))
       (build (expand-file-name "elpaca/" elpaca-builds-directory))
       (order (cdr elpaca-order))
       (default-directory repo))
  (add-to-list 'load-path (if (file-exists-p build) build repo))
  (unless (file-exists-p repo)
    (make-directory repo t)
    (when (<= emacs-major-version 28) (require 'subr-x))
    (condition-case-unless-debug err
        (if-let* ((buffer (pop-to-buffer-same-window "*elpaca-bootstrap*"))
                  ((zerop (apply #'call-process `("git" nil ,buffer t "clone"
                                                  ,@(when-let* ((depth (plist-get order :depth)))
                                                      (list (format "--depth=%d" depth) "--no-single-branch"))
                                                  ,(plist-get order :repo) ,repo))))
                  ((zerop (call-process "git" nil buffer t "checkout"
                                        (or (plist-get order :ref) "--"))))
                  (emacs (concat invocation-directory invocation-name))
                  ((zerop (call-process emacs nil buffer nil "-Q" "-L" "." "--batch"
                                        "--eval" "(byte-recompile-directory \".\" 0 'force)")))
                  ((require 'elpaca))
                  ((elpaca-generate-autoloads "elpaca" repo)))
            (progn (message "%s" (buffer-string)) (kill-buffer buffer))
          (error "%s" (with-current-buffer buffer (buffer-string))))
      ((error) (warn "%s" err) (delete-directory repo 'recursive))))
  (unless (require 'elpaca-autoloads nil t)
    (require 'elpaca)
    (elpaca-generate-autoloads "elpaca" repo)
    (let ((load-source-file-function nil)) (load "./elpaca-autoloads"))))
(add-hook 'after-init-hook #'elpaca-process-queues)
(elpaca `(,@elpaca-order))

;; Compile everything.
;;(setq straight-byte-compile t) ;; ensure byte compilation is enabled
;;(native-compile-async (expand-file-name "straight/build" straight-base-dir) 'recursively)
(setq package-enable-at-startup nil)
#+END_SRC

** Use-package
#+BEGIN_SRC elisp
(elpaca elpaca-use-package
  ;; Enable use-package :ensure support for Elpaca.
  (elpaca-use-package-mode))

(setq elpaca-use-package-by-default t)

(require 'use-package)

(setq use-package-compute-statistics t
      package-archives '(("melpa" . "https://melpa.org/packages/")
                         ("org" . "https://orgmode.org/elpa/")
                         ("elpa" . "https://elpa.gnu.org/packages/")))
#+END_SRC

** Maximum native eln speed.
Look for native-compile-async using variable "C-h v =native-comp-eln-load-path="
#+BEGIN_SRC elisp

(when (string= (system-name) "WarMachine")
  (setq native-comp-speed 3)
  (setq native-comp-compiler-options '("-march=znver2" "-Ofast" "-g0" "-fno-finite-math-only" "-fgraphite-identity" "-floop-nest-optimize" "-fdevirtualize-at-ltrans" "-fipa-pta" "-fno-semantic-interposition" "-flto=auto" "-fuse-linker-plugin"))
  (setq native-comp-driver-options '("-march=znver2" "-Ofast" "-g0" "-fno-finite-math-only" "-fgraphite-identity" "-floop-nest-optimize" "-fdevirtualize-at-ltrans" "-fipa-pta" "-fno-semantic-interposition" "-flto=auto" "-fuse-linker-plugin"))
  (native-compile-async "/usr/local/lib/emacs/31.0.50/native-lisp" 'recursively))

(when (string= (system-name) "Tiffany")
  (setq native-comp-speed 3)
  (setq native-comp-compiler-options '("-march=znver3" "-Ofast" "-g0" "-fno-finite-math-only" "-fgraphite-identity" "-floop-nest-optimize" "-fdevirtualize-at-ltrans" "-fipa-pta" "-fno-semantic-interposition" "-flto=auto" "-fuse-linker-plugin"))
  (setq native-comp-driver-options '("-march=znver3" "-Ofast" "-g0" "-fno-finite-math-only" "-fgraphite-identity" "-floop-nest-optimize" "-fdevirtualize-at-ltrans" "-fipa-pta" "-fno-semantic-interposition" "-flto=auto" "-fuse-linker-plugin"))
  (native-compile-async "/usr/lib/emacs/30.2/native-lisp" 'recursively))
#+END_SRC

* General settings

** Emacs
#+BEGIN_SRC elisp
;; Global tab width and use spaces
(use-package emacs
  :ensure nil
  :defer t
  :bind
  (("<C-wheel-down>" . text-scale-increase)
   ("<C-wheel-up>" . text-scale-decrease)
   ("<f11>" . 'my/toggle-mode-line)        ;; toggle modeline
   ("<f12>" . 'my/zen-mode)        ;; toggle olivetti (zen mode)
   ("C-+" . text-scale-increase)
   ("C--" . text-scale-decrease)
   ("C-." . avy-goto-char)
   ;; C-c
   ("C-c C-u" . package-upgrade-all)
   ("C-c R" . restart-emacs)              ;; restart emacs
   ("C-c T" . vterm)
   ("C-c b" . nyan-mode)
   ("C-c c" . compile)
   ("C-c g" . gdb)
   ("C-c i" . 'my/indent-whole-buffer)
   ("C-c k" . 'my/kill-all-buffers)        ;; kill all buffers
   ("C-c n" . neotree-toggle)
   ("C-c p" . dmenu)
   ("C-c q" . 'my/visit-qtile)             ;; visit qtile config
   ("C-c r" . recentf)                    ;; recent files list
   ("C-c t" . 'vterm-toggle)
   ("C-c v" . view-mode)
   ("C-c w h" . 'my/highlight-word)
   ("C-c w l" . 'my/copy-whole-line)
   ("C-c w w" . 'my/kill-whole-word)
   ("C-c y" . yas-expand)
   ;; C-x
   ("C-x 2" . 'my/split-and-follow-horizontally)
   ("C-x 3" . 'my/split-and-follow-vertically)
   ("C-x B" . infu-bionic-reading-buffer)
   ("C-x C-k" . kill-buffer)              ;; kill buffer
   ("C-x b" . consult-buffer)
   ("C-z" . repeat)
   ("M-y" . popup-kill-ring)
   ("C-c e" . 'my/visit-init)              ;; visit init.el
   ;; Project
                                        ;   ("C-c p p" . project-switch-project)
                                        ;  ("C-c p f" . project-find-file)

   ;; ;; Consult
   ;; ([remap bookmark-jump] . consult-bookmark)
   ;; ([remap goto-line] . consult-goto-line)
   ;; ([remap imenu] . consult-imenu)
   ;; ([remap project-switch-to-buffer] . consult-project-buffer)
   ;; ([remap repeat-complex-command] . consult-complex-command)
   ;; ([remap switch-to-buffer] . consult-buffer)
   ;; ([remap yank-pop] . consult-yank-pop)

   ("C-c M-x" . consult-mode-command)
                                        ;   ("C-c h" . consult-history)
   ("C-c k" . consult-kmacro)
   ("C-c m" . consult-man)
   ("C-c i" . consult-info)
   ("C-x M-:" . consult-complex-command)
   ("C-x b" . consult-buffer)
   ("C-x 4 b" . consult-buffer-other-window)
   ("C-x 5 b" . consult-buffer-other-frame)
   ("C-x t b" . consult-buffer-other-tab)
   ("C-x r b" . consult-bookmark)
   ("C-x p b" . consult-project-buffer)
   ("M-#" . consult-register-load)
   ("M-'" . consult-register-store)
   ("C-M-#" . consult-register)
   ("M-y" . consult-yank-pop)
   ;; M-g prefix (goto-map)
   ("M-g e" . consult-compile-error)
   ("M-g f" . consult-flymake)
   ("M-g g" . consult-goto-line)
   ("M-g M-g" . consult-goto-line)
   ("M-g o" . consult-outline)
   ("M-g m" . consult-mark)
   ("M-g k" . consult-global-mark)
   ("M-g i" . consult-imenu)
   ("M-g I" . consult-imenu-multi)
   ;; M-s prefix (search-map)
   ("M-s d" . consult-find)
   ("M-s c" . consult-locate)
   ("M-s g" . consult-grep)
   ("M-s G" . consult-git-grep)
   ("M-s r" . consult-ripgrep)
   ("M-s l" . consult-line)
   ("M-s L" . consult-line-multi)
   ("M-s k" . consult-keep-lines)
   ("M-s u" . consult-focus-lines)
   ("M-s e" . consult-isearch-history)
   ;; isearch-mode-map bindings
   :map isearch-mode-map
   ("M-e" . consult-isearch-history)
   ("M-s e" . consult-isearch-history)
   ("M-s l" . consult-line)
   ("M-s L" . consult-line-multi)
   ;; minibuffer-local-map / minibuffer history map
   :map minibuffer-local-map
   ("M-s" . consult-history)
   ("M-r" . consult-history))

  :custom
  (tab-width 4)
  (check-parens)
  (recentf 1)
  (indent-tabs-mode nil)
  (org-startup-indented nil)
  (treesit-font-lock-level 4)
  (enable-recursive-minibuffers t)
  (read-extended-command-predicate #'command-completion-default-include-p)
  (treesit-auto-install-grammar t) ; EMACS-31
  (delete-by-moving-to-trash t) ;; Move deleted files to trash instead of permantenly deleting
  (split-width-threshold 300)
  (switch-to-buffer-obey-display-actions t)
  (tab-always-indent 'complete)
  (use-short-answers t)
  (warning-minimum-level :emergency)
  (enable-recursive-minibuffers t)) ; Enable recursive minibuffers

;; Add prompt indicator to `completing-read-multiple'.
;; We display [CRM<separator>], e.g., [CRM,] if the separator is a comma.
(defun crm-indicator (args)
  (cons (format "[CRM%s] %s"
                (replace-regexp-in-string
                 "\\`\\[.*?]\\*\\|\\[.*?]\\*\\'" ""
                 crm-separator)
                (car args))
        (cdr args)))
(advice-add #'completing-read-multiple :filter-args #'crm-indicator)

;; Do not allow the cursor in the minibuffer prompt
(setq minibuffer-prompt-properties
      '(read-only t cursor-intangible t face minibuffer-prompt))
(add-hook 'minibuffer-setup-hook #'cursor-intangible-mode)
                                        ;  (add-hook 'after-save-hook #'indent-region)
                                        ; (add-hook 'after-save-hook #'my/tangle-config-org-on-save)
#+END_SRC

** UTF-8 everywhere
#+begin_src elisp
(setq coding-system-for-read 'utf-8
      coding-system-for-write 'utf-8
      default-buffer-file-coding-system 'utf-8
      locale-coding-system 'utf-8
      selection-coding-system 'utf-8
      inhibit-eol-conversion t)
(set-language-environment 'utf-8)
#+end_src

** Visible bell
#+BEGIN_SRC elisp
(setq visible-bell nil
      ring-bell-function 'double-flash-mode-line)
(defun double-flash-mode-line ()
  (let ((flash-sec (/ 3.0 20)))
    (invert-face 'mode-line)
    (run-with-timer flash-sec nil #'invert-face 'mode-line)))
#+end_src

** Disable line numbers, mode-line, tab-bar and etc.
#+BEGIN_SRC elisp
(dolist (mode '(term-mode-hook
                shell-mode-hook
                treemacs-mode-hook
                dashboad-mode-hook
                neotree-mode-hook
                dashboard-mode-hook
                pdf-view-mode-hook
                vterm-mode-hook
                eshell-mode-hook))
  (add-hook mode (lambda () (display-line-numbers-mode 0) (setq mode-line-format nil) (tab-bar-mode 0) (tab-line-mode 0))))
#+END_SRC

** Whitespace cleanUp
#+begin_src elisp
(add-hook 'before-save-hook 'whitespace-cleanup)
#+end_src

** isearch
#+begin_src elisp
;; (setq isearch-allow-motion t
;;       isearch-motion-changes-direction t)

(setq isearch-lazy-count t)
(setq lazy-highlight-cleanup nil) ;; Keep highlights after search ends
(setq lazy-highlight-initial-delay 0) ;; No delay in highlighting
#+end_src

** Bionic Reading
#+BEGIN_SRC elisp :tangle "lisp/bionic-reading.el"
;; -*- lexical-binding: t; -*-
(defvar infu-bionic-reading-face nil "a face for `infu-bionic-reading-region'.")

(setq infu-bionic-reading-face 'bold)
;; try
;; 'bold
;; 'error
;; 'warning
;; 'highlight
;; or any value of M-x list-faces-display

(defun infu-bionic-reading-buffer ()
  "Bold the first few chars of every word in current buffer.
Version 2022-05-21"
  (interactive)
  (infu-bionic-reading-region (point-min) (point-max)))

(defun infu-bionic-reading-region (Begin End)
  "Bold the first few chars of every word in region.
Version 2022-05-21"
  (interactive "r")
  (let (xBounds xWordBegin xWordEnd  )
    (save-restriction
      (narrow-to-region Begin End)
      (goto-char (point-min))
      (while (forward-word)
        ;; bold the first half of the word to the left of cursor
        (setq xBounds (bounds-of-thing-at-point 'word))
        (setq xWordBegin (car xBounds))
        (setq xWordEnd (cdr xBounds))
        (setq xBoldEndPos (+ xWordBegin (1+ (/ (- xWordEnd xWordBegin) 2))))
        (put-text-property xWordBegin xBoldEndPos
                           'font-lock-face infu-bionic-reading-face)))))

(provide 'bionic-reading)
#+END_SRC

** Features

*** Zen mode
#+begin_src elisp
(defun my/zen-mode ()
  "Toggle Olivetti mode with additional distraction-free settings."
  (interactive)
  (if olivetti-mode
      (progn
        (olivetti-mode 0)
        (display-line-numbers-mode 1)
        (message "Zen Mode disbaled"))  ;; Re-enable line numbers
    (progn
      (olivetti-mode 1)
      (display-line-numbers-mode -1)
      (message "Zen Mode enabled")))) ;; Disable line numbers
#+end_src

*** Auto indent
#+begin_src elisp
(defun my/indent-buffer-before-save ()
  "Indent the whole buffer before saving."
  (when (derived-mode-p 'prog-mode) ;; Only in programming modes
    (save-excursion
      (indent-region (point-min) (point-max)))))

(add-hook 'before-save-hook #'my/indent-buffer-before-save)
#+end_src

*** Auto tangle
#+begin_src elisp
(defun my/tangle-config-org-on-save ()
  "Automatically tangle config.org after saving."
  (when (string-equal (buffer-file-name)
                      (expand-file-name "config.org" user-emacs-directory))
    (org-babel-tangle)
    (message "Tangling completed")))
(add-hook 'after-save-hook #'my/tangle-config-org-on-save)
#+end_src

*** Don't let the specified get killed.
#+BEGIN_SRC elisp
;; -*- lexical-binding: t; -*-
(defun my/protect-vital-buffers ()
  "Prevent killing vital buffers."
  (not (member (buffer-name) '("*Welcome-screen*"))))
(message "I'm Immortal")
(add-hook 'kill-buffer-query-functions #'my/protect-vital-buffers)
#+END_SRC

*** Toggle modeline
#+BEGIN_SRC elisp
(defun my/toggle-mode-line ()
  "Toggles the modeline on and off."
  (interactive)
  (setq mode-line-format
        (if (equal mode-line-format nil)
            (default-value 'mode-line-format)) )
  (redraw-display))
#+end_src

*** Visit the config.
#+BEGIN_SRC elisp
(defun my/visit-init ()
  "Open the Emacs init file."
  (interactive)
  (message "Opening Emacs Init")
  (find-file (expand-file-name "config.org" user-emacs-directory)))
#+END_SRC

*** Visit the qtile config.
#+BEGIN_SRC elisp
(defun my/visit-qtile ()
  "Open the qtile cofnig file."
  (interactive)
  (message "Opening Qtile Configuration")
  (find-file "~/.config/qtile/config.py"))
#+END_SRC

*** Highlight the word.
#+BEGIN_SRC elisp
(defun my/highlight-word ()
  "Highlight the current word you are on."
  (interactive)
  (message "Highlighting word")
  (backward-word 1)
  (set-mark-command nil)
  (forward-word 1))
#+END_SRC

*** Close all buffers
#+BEGIN_SRC elisp
(defun my/kill-all-buffers ()
  "Kill all the buffers."
  (interactive)
  (message "Killed all buffers")
  (mapc 'kill-buffer (buffer-list)))
#+end_src

*** Switch cursor automatically to new window.
#+BEGIN_SRC elisp
(defun my/split-and-follow-horizontally ()
  "Split horziontally and follow."
  (interactive)
  (split-window-below)
  (balance-windows)
  (other-window 1))

(defun my/split-and-follow-vertically ()
  "Split vertically and follow."
  (interactive)
  (split-window-right)
  (balance-windows)
  (other-window 1))
#+END_SRC

*** Kill the whole word
#+BEGIN_SRC elisp
(defun my/kill-whole-word ()
  "kill the whole word."
  (interactive)
  (message "Killed whole word")
  (backward-word)
  (kill-word 1))
#+END_SRC

*** Copy the whole line
#+BEGIN_SRC elisp
(defun my/copy-whole-line ()
  "Copy whole line."
  (interactive)
  (message "Copied whole line")
  (save-excursion
    (kill-new
     (buffer-substring
      (pos-bol)
      (pos-eol)))))
#+END_SRC

*** Indent whole buffer
#+begin_src elisp
(defun my/indent-whole-buffer ()
  "Indent the entire buffer without affecting point or mark."
  (interactive)
  (save-excursion
    (save-restriction
      (indent-region (point-min) (point-max)))))
#+end_src

* General Pacakges

** Dired
Builtin package allows =Dired= operations like copying and renaming files to run asynchronously.
#+begin_src elisp
(use-package dired
  :ensure nil
  :custom
  (dired-mode))
                                        ;  :hook (dired-mode . dired-hide-details-mode)
                                        ; :custom (dired-listing-switches "-alh --group-directories-first"))
#+end_src

** Project
#+begin_src elisp
(use-package project
  :ensure nil
  :commands (project))
#+end_src

** Eshell
However, Eshell will likely not recognize bash-specific syntax like alias or some functions because Eshell syntax differs from bash.
#+begin_src elisp
;; Load environment variables from bash in Emacs.
(use-package eshell-toggle
  :ensure (:host github :repo "4DA/eshell-toggle" :main "eshell-toggle.el")
  :commands (eshell-toggle)
  :custom
  (exec-path-from-shell-initialize)
  (eshell-toggle-size-fraction 4)
  (eshell-toggle-default-directory "~/")
  (eshell-toggle-find-project-root-package t) ;; for projectile
  ;;(eshell-toggle-find-project-root-package 'projectile) ;; for projectile
  ;; (eshell-toggle-use-projectile-root 'project) ;; for in-built project.el
  (eshell-toggle-run-command nil)
  (eshell-toggle-init-function #'eshell-toggle-init-ansi-term))
#+end_src

** Icons
#+BEGIN_SRC elisp
;; Nerd icons
(use-package nerd-icons
  :ensure t
  :hook (elpaca-after-init .  nerd-icons))

;; Nerd icons dired
(use-package nerd-icons-dired
  :ensure t
  :hook (dired-mode . nerd-icons-dired-mode))

;; Nerd icons completion
(use-package nerd-icons-completion
  :ensure t
  :hook (emacs-startup-hook . nerd-icons-completion-mode))
#+END_SRC

** Kind icon
#+begin_src elisp
(use-package kind-icon
  :ensure t
  :hook (corfu-mode . (lambda ()
                        (add-to-list 'corfu-margin-formatters #'kind-icon-margin-formatter)
                        (add-hook 'modus-themes-after-load-theme-hook #'kind-icon-reset-cache)
                        (add-hook 'ef-themes-post-load-hook #'kind-icon-reset-cache)))
  :custom
  (kind-icon-use-icons t)
  (kind-icon-default-face 'corfu-default)
  (kind-icon-blend-background nil)
  (kind-icon-blend-frac 0.08))
#+end_src

** Vterm
#+BEGIN_SRC elisp
(use-package vterm
  :ensure t
  :commands (vterm)
  :bind (("C-c T" . vterm))
  :custom
  (vterm-always-compile-module t))
#+end_src

** Vterm-Toggle
#+begin_src elisp
(use-package vterm-toggle
:ensure t
:commands vterm-toggle
:custom
(vterm-max-scrollback 1000))

(defun vterm-split-window-below ()
(interactive)
(vterm)
(split-window-below -12)
(previous-buffer)
(other-window 1))

(defun vterm-toggle ()
"Toggle vterm open and hide with Control + `"
(interactive)
(if (eq major-mode 'vterm-mode)
(delete-window)
(vterm-split-window-below)))
#+end_src

** Which key
#+BEGIN_SRC elisp
(use-package which-key
  :ensure t
  :hook (after-init . which-key-mode)
  :custom
  (which-key-lighter "")
                                        ;  (which-key-sort-order #'which-key-order-alpha)
  (which-key-sort-uppercase-first nil)
  (which-key-add-column-padding 1)
  (which-key-max-display-columns nil)
  (which-key-min-display-lines 6)
  (which-key-compute-remaps t)
  (which-key-side-window-slot -10)
  (which-key-separator " -> ")
  (which-key-allow-evil-operators t)
  (which-key-use-C-h-commands t)
  (which-key-show-remaining-keys t)
  (which-key-show-prefix 'bottom)
  (which-key-idle-delay 0.3) ;; company-idle-delay set to low causes latency while typing use with caution.
  (which-key-setup-side-window-bottom)
  (which-key-setup-minibuffer))
#+END_SRC

** Persistent history.
#+BEGIN_SRC elisp
(use-package savehist
  :ensure nil
  :hook (emacs-startup-hook . savehist-mode)
  :custom
  (history-length 15)
  (savehist-file "~/.config/emacs/savehist")
  (history-delete-duplicates t)
  (savehist-save-minibuffer-history 1)
  (savehist-additional-variables
   '(kill-ring
     search-ring
     regexp-search-ring)))
#+END_SRC

** Helpful
#+begin_src elisp
(use-package helpful
  :ensure t
  :bind (("C-h f" . helpful-callable)
         ("C-h v" . helpful-variable)
         ("C-h k" . helpful-key)
         ("C-h F" . helpful-function)
         ("C-h C" . helpful-command)))
#+end_src


** COMMENT Hardtime
#+BEGIN_SRC elisp
(use-package hardtime
  :ensure t
  :preface
  (defun evil-hardtime-check-command ()
    "Return non-nil if the currently executed command should be checked."
    (memq this-command '( next-line previous-line evil-previous-visual-line
                          right-char left-char left-word right-word
                          evil-forward-char evil-backward-char
                          evil-next-line evil-previous-line)))
  :custom
  (hardtime-predicate #'evil-hardtime-check-command)
  :hook
  (text-mode . hardtime-mode)
  (prog-mode . hardtime-mode))
#+END_SRC

** Ace jump mode
#+begin_src elisp
(use-package ace-jump-mode
  :ensure t
  :hook (emacs-startup . ace-jump-mode)
  :bind
  ("C-c j" . 'ace-jump-mode))
#+end_src

* Writing

** Org
#+BEGIN_SRC elisp
;; Org mode, if you still want it for notes/tasks
(use-package org
  :ensure t
  :mode ("\\.org\\'" . org-mode)
  :commands (org-agenda org-capture)
  :custom
  (org-agenda-files '("~/Documents/org/"))
  (org-log-done 'time)
  (org-hide-emphasis-markers t) ;; hide *bold*, /italic/, etc.
  (org-hide-leading-stars t)
  (org-ellipsis "  .")
  (org-src-fontify-natively t)
  (org-cycle-separator-lines 1)
  (org-src-tab-acts-natively t)
  (org-pretty-entities t)
  (org-edit-src-content-indentation 0)
  (org-fontify-whole-headline-line t)
  (org-fontify-done-headline t)
  (org-fontify-quote-and-verse-blocks t)
  :hook (org-mode . my/force-org-font-lock))

;;;; Overcome the problem of 'org-mode' font lock after opening a file.
(defun my/force-org-font-lock ()
  "Force font-lock to apply to the whole buffer"
  (font-lock-ensure))
(add-hook 'org-mode-hook #'my/force-org-font-lock)

;; Better list bullets
(font-lock-add-keywords 'org-mode
                        '(("^ *\\([-]\\) "
                           (0 (prog1 () (compose-region (match-beginning 1) (match-end 1) "•"))))))

;; Optional: Enhanced list styling
(setq org-list-demote-modify-bullet
      '(("+" . "-") ("-" . "+") ("*" . "+")))

(with-eval-after-load 'org
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((emacs-lisp . t)
     (python . t)
     (lisp . t)
     (shell . t)
     (lua . t)
     (calc . t)
     (sql . t)
     (C . t))))
(custom-set-faces
 '(variable-pitch ((t (:family "Linux Libertine" :height 90))))
 '(fixed-pitch ((t (:family "JetBrains Mono" :height 90))))
 ;; Org document title size and weight
 '(org-document-title ((t (:height 2.0 :weight bold))))
 ;; Org headings levels 1-7 weight and height
 '(org-level-1 ((t (:height 1.7 :weight bold))))
 '(org-level-2 ((t (:height 1.6 :weight bold))))
 '(org-level-3 ((t (:height 1.5 :weight bold))))
 '(org-level-4 ((t (:height 1.4 :weight bold))))
 '(org-level-5 ((t (:weight bold))))
 '(org-level-6 ((t (:weight bold))))
 '(org-level-7 ((t (:weight bold))))
 '(org-block ((t (:inherit fixed-pitch))))
 '(org-code ((t (:inherit (shadow fixed-pitch)))))
 '(org-table ((t (:inherit fixed-pitch))))
 '(org-verbatim ((t (:inherit (shadow fixed-pitch)))))
 '(org-special-keyword ((t (:inherit (font-lock-comment-face fixed-pitch)))))
 '(org-meta-line ((t (:inherit (font-lock-comment-face fixed-pitch)))))
 '(org-checkbox ((t (:inherit fixed-pitch)))))
#+end_SRC

*** COMMENT Org Modern
#+begin_src elisp
(use-package org-modern
  :ensure t
  :hook ((org-mode . org-modern-mode)
         (org-agenda-finalize . org-modern-agenda))
  :custom
  (org-hide-emphasis-markers t)
  (org-pretty-entities t)
  (org-insert-heading-respect-content t)
  (org-agenda-tags-column 0))
#+end_src

*** COMMENT Org bullet
#+begin_src elisp
(use-package org-bullets
  :ensure t
  :hook (org-mode . org-bullets-mode)
  :custom
  (org-bullets-bullet-list '("●" "◆" "○" "◇" "•")))
#+end_src

** olivetti
#+begin_src elisp
(use-package olivetti
  :ensure t
  :commands (olivetti-mode)
  :custom
  ;; Set text width to a comfortable fraction of the window
  ( olivetti-body-width 0.9) ;; Or set as integer for fixed width
  ;; Set minimum body width for wide windows
  (olivetti-minimum-body-width 80)
  ;; Remember the state of visual-line-mode when entering/exiting Olivetti
  (olivetti-recall-visual-line-mode-entry-state t)
  ;; Choose how margins are rendered: 'margins, 'fringe, or 'fancy
  (olivetti-style 'fancy)
  ;; Optionally customize the fringe face for Olivetti buffers
  (custom-set-faces
   '(olivetti-fringe ((t (:background "#111111"))))))
#+end_src

* Vim Layer
** Evil mode
#+BEGIN_SRC elisp
(use-package evil
  :ensure t
  :disabled t
  :hook (emacs-startup-hook . evil-mode)
  :custom
  (evil-want-integration t)
  (evil-want-keybinding nil)
                                        ;  (evil-want-C-u-scroll t)
  (evil-want-C-u-delete t)
  (evil-default-state 'normal)
  (evil-set-initial-state 'dired-mode 'normal)
  :bind
  (:map evil-normal-state-map
        ("SPC f" . find-file)
        ("SPC d" . dired)
        ("SPC pv" . dired-jump)
        ("SPC c" . compile)
        ("SPC w" . save-buffer)
        ("SPC q" . evil-quit)
        ("SPC r" . restart-emacs)
        ("SPC B" . ibuffer)

        ("U" . evil-redo)

        ;; Consult
        ("SPC b" . consult-buffer)
        ("SPC s" . consult-find)
        ("SPC g" . consult-grep)

        ("SPC u" . undo)
        ("SPC z" . undo-redo)
        ("SPC G u" . evil-upcase)
        ("SPC SPC" . org-babel-tangle)
        ("SPC t" . vterm-toggle-cd)
        ("SPC o" . other-window)
        ("SPC k" . kill-buffer)
        ("gcc" . comment-line)))
#+END_SRC

** Evil collection
#+BEGIN_SRC elisp
(use-package evil-collection
  :ensure t
  :hook (evil-mode . evil-collection-init))
#+END_SRC

** Evil tutor
#+BEGIN_SRC elisp
(use-package evil-tutor
  :ensure t
  :commands (evil-tutor))
#+END_SRC

* Programming

** M-x compile
#+BEGIN_SRC elisp
(defun compile-and-run-current-file ()
  "Compile or run the current file depending on its extension."
  (interactive)
  (let* ((file (shell-quote-argument (buffer-file-name)))
         (ext (file-name-extension file))
         (cmd
          (cond
           ((member ext '("c"))
            (format "gcc %s -o /tmp/a.out && /tmp/a.out" file))
           ((member ext '("asm" "s"))
            (format "nasm -f elf64 %s -o /tmp/a.o && ld /tmp/a.o -o /tmp/a.out && /tmp/a.out" file))
           ((member ext '("py"))
            (format "python3 %s" file))
           ((member ext '("lua"))
            (format "lua %s" file))
           ((member ext '("go"))
            (format "go run %s" file))
           (t (format "chmod +x %s && %s" file file)))))
    (compilation-start cmd)))

(add-to-list 'display-buffer-alist
             '("\\*compilation\\*"
               (display-buffer-reuse-window display-buffer-at-bottom)
               (window-height . 0.25)))

(global-set-key (kbd "C-c r") 'compile-and-run-current-file)
#+END_SRC

** GDB
#+BEGIN_SRC elisp
(use-package gdb-mi
  :ensure (:host github :repo "weirdNox/emacs-gdb" :files ("*.el" "*.c"
                                                           "*.h" "Makefile")))
(with-eval-after-load 'gdb-mi
  (fmakunbound 'gdb)
  (fmakunbound 'gdb-enable-debug))
#+END_SRC

* Completion

** COMMENT Mini buffer
Below is a modern Emacs completion system configuration using use-package, leveraging only built-in packages (no Vertico, Ivy, or Helm). This setup uses fido-mode, fido-vertical-mode, and modern completion styles for a smooth, efficient experience:
#+begin_src elisp
(use-package minibuffer
  :ensure nil
  :ensure nil
  :hook (emacs-startup . (lambda ()
                           (fido-mode 1)
                           (fido-vertical-mode 1)
                           (setq completion-styles '(basic flex))))
  :custom
  (completions-format 'one-column)
  (completions-max-height 20)
  (completion-auto-help 'visible)
  (completion-auto-select nil)
  (completions-sort 'historical)
  (completion-ignore-case t)
  (completion-cycle-threshold 3)
  (define-key minibuffer-local-completion-map (kbd "C-n") 'minibuffer-next-completion)
  (define-key minibuffer-local-completion-map (kbd "C-p") 'minibuffer-previous-completion)
  (when (boundp 'completion-preview-mode)
    (completion-preview-mode 1)))
#+end_src

** Corfu
#+begin_src elisp
(use-package corfu
  :ensure t
  :hook ((prog-mode . global-corfu-mode)
         (corfu-mode . corfu-history-mode)
         (corfu-mode . corfu-indexed-mode)
         (minibuffer-setup-hook . (lambda ()
                                    (when (local-variable-p 'completion-at-point-functions)
                                      (setq-local corfu-auto nil)
                                      (corfu-mode 1)))))
  :bind (:map corfu-map
              ("TAB" . corfu-next)
              ("S-TAB" . corfu-previous)
              ("RET" . corfu-insert)
              ("M-." . corfu-show-location)
              ("M-h" . corfu-show-documentation))
  :custom
  (corfu-auto t)
  (corfu-auto-delay 0.0)
  (corfu-auto-prefix 2)
  (corfu-cycle t)
  (corfu-preselect 'prompt)
  (corfu-on-exact-match nil)
  (corfu-scroll-margin 5)
  (corfu-popupinfo-delay '(0.4 . 0.2))
  (corfu-echo-documentation-nil)
  (corfu-popupinfo-mode))
#+end_src

** Corfu Popupinfo
#+begin_src elisp
;; (use-package corfu-popupinfo
;;   :ensure (:host github :repo "minad/corfu" :files ("extensions/corfu-popupinfo.el"))
;;   :after corfu
;;   :hook (corfu-mode . corfu-popupinfo-mode)
;;   :custom
;;   (corfu-popupinfo-hide nil))


(use-package corfu-popupinfo
  :ensure (:host github :repo "minad/corfu" :files ("extensions/corfu-popupinfo.el"))
  :hook (corfu-mode . corfu-popupinfo-mode)
  :bind ( ; Bind these to toggle/scroll documentation
         :map corfu-map
         ("M-p" . corfu-popupinfo-scroll-down)
         ("M-n" . corfu-popupinfo-scroll-up)
         ("M-d" . corfu-popupinfo-toggle))
  :custom
  (corfu-popupinfo-delay nil)
  (corfu-popupinfo-max-height 15)
  :config
  ;; Otherwise, the popupinfo will stay open on ESC or `C-g'!
  (add-hook
   'completion-in-region-mode-hook
   (satch-defun +corfu--hide-popupinfo-h ()
                (when (and (not completion-in-region-mode) (boundp 'corfu-popupinfo--hide))
                  (corfu-popupinfo--hide)))))
#+end_src

** Cape
#+begin_src elisp
(use-package cape
  :ensure t
  :hook ((eshell-mode . (lambda ()
                          (setq-local completion-at-point-functions
                                      (list #'cape-file #'pcomplete-completions-at-point))))
         (org-mode . (lambda ()
                       (add-to-list 'completion-at-point-functions #'cape-dabbrev)))
         (emacs-startup-hook . (lambda ()
                                 ;; Add useful completion sources globally
                                 (add-to-list 'completion-at-point-functions #'cape-dabbrev)
                                 (add-to-list 'completion-at-point-functions #'cape-file)
                                 (add-to-list 'completion-at-point-functions #'cape-elisp-block)
                                 ;; Silence pcomplete
                                 (advice-add 'pcomplete-completions-at-point :around #'cape-wrap-silent)
                                 (advice-add 'pcomplete-completions-at-point :around #'cape-wrap-purify)))))
#+end_src

** orderless
#+begin_src elisp
(use-package orderless
  :ensure t
  :custom
  (completion-styles '(orderless))
  (completion-category-overrides '((file (styles basic partial-completion))))
  (orderless-matching-styles '(orderless-literal orderless-regexp orderless-flex)))
#+end_src

** Vertico
#+begin_src elisp
(use-package vertico
  :ensure t
  :hook (elpaca-after-init . vertico-mode)
  :custom
  (vertico-cycle t)          ;; Wrap around candidates
  (vertico-resize nil)
  (vertico-multiform-mode 1)
  (vertico-multiform-commands
   (consult-line buffer)
   (consult-lie-thins-at-point buffer)
   (consult-recent-file buffer)
   (consult-mode-command buffer)
   (consult-complex-command buffer)
   (consult-bindings buffer)
   (consult-locate buffer)
   (consult-project-buffer buffer)
   (vertico-resize t)            ;; Resize the Vertico minibuffer dynamically
   (vertico-count 15)            ;; Limit the number of completion candidates
   (consult-ripgrep buffer)
   (consult-fd buffer)))
#+end_src

** Marginalia
#+begin_src elisp
;; Add annotations to minibuffer completion candidates
(use-package marginalia
  :ensure t
  :hook (vertico-mode . marginalia-mode))
#+end_src

** Consult
#+begin_src elisp
(use-package consult
  :ensure t
  :commands (consult-grep consult-find consult-line consult-buffer)
  :custom
  (consult-buffer-filter
   '(
     "\\` "
     "\\`\\*Completions\\*\\'"
     "\\`\\*Backtrace\\*\\'"
     "\\`\\*Messages\\*\\'"
     "\\`\\*Warnings\\*\\'"
     "\\`\\*straight-process\\*\\'"
     "\\`\\*XELB-DEBUG\\*\\'"
     "magit*"
     "\\`\\*Org Preview LaTeX Output\\*\\'"
     "\\`\\*Flymake log\\*\\'"
     "\\`\\*Semantic SymRef\\*\\'"
     "\\`\\*tramp/.*\\*\\'"
     ))
  (consult-line-threshold 100000000)
  (consult-line-fallback (lambda () (error "Buffer too large"))
                         (consult-line-fallback (lambda () (consult-ripgrep ...))
                                                (consult-line-fallback (lambda () (occur ...))))))

;;  :bind (("M-s M-g" . consult-grep)       ;; Search with ripgrep
;;         ("M-s M-f" . consult-find)       ;; Find files
;;         ("M-s M-l" . consult-line)       ;; Search in buffer
;;         ("M-s M-b" . consult-buffer)))   ;; Buffer switching

(defvar consult--source-bookmark
  `(:name     "Bookmark"
              :narrow   ?m
              :category bookmark
              :face     consult-bookmark
              :history  bookmark-history
              :items    ,#'bookmark-all-names
              :action   ,#'consult--bookmark-action))


(defun my-rg-fzf-candidates (pattern)
  (split-string
   (shell-command-to-string
    (format "rg --files | fzf --query='%s'" pattern)) "\n" t))

(defun my-vertico-rg-fzf ()
  (interactive)
  (let ((file (completing-read "Select file: " #'my-rg-fzf-candidates)))
    (when file
      (find-file file))))
#+end_src

* Snippets

** Yasnippet
#+begin_src elisp
(use-package yasnippet
  :ensure t
  :hook (prog-mode . yas-global-mode)
  :config
  (yas-reload-all))
#+end_src

*** Source Code block
#+begin_src elisp :tangle snippets/org-mode/src
# -*- mode: snippet -*-
# name: source block
# key: src
# --
,#+begin_src ${1:Language}
$0
,#+end_src
#+end_src

*** Template
#+begin_src elisp :tangle snippets/org-mode/temp
# -*- mode: snippet -*-
# name: template
# key: temp
# --
,#+TITLE: ${1:title}
,#+AUTHOR: ${2:author}
,#+DATE: `(format-time-string "%Y-%m-%d")`
-----
#+end_src

*** Insert TODO heading with Priority and Tags
#+begin_src elisp :tangle snippets/org-mode/todo
# -*- mode: snippet -*-
# name: TODO entry
# key: todo
# --
\* TODO [#${1:A}] ${2:Task description}       :${3:tags}:
DEADLINE: <${4:yyyy-mm-dd}>
$0
#+end_src

*** Insert Org table with caption
#+begin_src elisp :tangle snippets/org-mode/table
# -*- mode: snippet -*-
# name: table with caption
# key: table
# --
|--------------+--------------|
| ${1:Column1} | ${2:Column2} |
|--------------+--------------|
| ${4:Value1}  | ${5:Value2}  |
|--------------+--------------|
,#+CAPTION: ${7:Table caption here}
$0
#+end_src

* Programming

** Lua mode
#+begin_src elisp
(use-package lua-mode
  :ensure nil
  :mode ("\\.lua\\'" . lua-ts-mode))
#+end_src

** Python mode
#+begin_src elisp
(use-package lua-mode
  :ensure nil
  :mode ("\\.py\\'" . python-ts-mode))
#+end_src

** Go
#+begin_src elisp
(use-package go-mode
  :ensure nil
  :mode ("\\.go\\'" . go-ts-mode))
#+end_src

** emacs-lisp
#+begin_src elisp
(use-package emacs-lisp-mode
  :ensure nil
  :mode ("\\.el\\'" . emacs-lisp-mode))
#+end_src

** Auto remap
#+begin_src elisp
;; Auto-remap major modes to tree-sitter versions
(setq major-mode-remap-alist
      '((bash-mode . bash-ts-mode)
        (c-mode . c-ts-mode)
        (c++-mode . c++-ts-mode)
        (css-mode . css-ts-mode)
        ((lua-mode . lua-ts-mode))
        (go-mode . go-ts-mode)
        (java-mode . java-ts-mode)
        (js-mode . js-ts-mode)
        (javascript-mode . js-ts-mode)
        (json-mode . json-ts-mode)
        (python-mode . python-ts-mode)
        (rust-mode . rust-ts-mode)
        (typescript-mode . typescript-ts-mode)))
#+end_src

** Treesit auto
#+begin_src elisp
;; Treesit-auto for automatic grammar management
(use-package treesit-auto
  :ensure t
  :hook (prog-mode . treesit-auto-mode)
  :custom
  (treesit-auto-install t))  ; Prompt before installing grammars

(with-eval-after-load 'treesit-auto
  (treesit-auto-add-to-auto-mode-alist 'all)
  (global-treesit-auto-mode)
  ;; Auto-install parsers
  (setq treesit-language-source-alist
        '((c "https://github.com/tree-sitter/tree-sitter-c")
          (cpp "https://github.com/tree-sitter/tree-sitter-cpp")
          (python "https://github.com/tree-sitter/tree-sitter-python")
          (lua "https://github.com/Azganoth/tree-sitter-lua")
          (bash "https://github.com/tree-sitter/tree-sitter-bash")
          (rust "https://github.com/tree-sitter/tree-sitter-rust"))))

#+end_src

** COMMENT LSP mode
#+begin_src elisp
(use-package lsp-mode
  :ensure t
  :hook ((prog-mode . lsp-deferred)
         (lsp-mode . lsp-enable-which-key-integration))
  :commands (lsp lsp-deferred)
  :custom
  ;; Performance optimizations
  (lsp-completion-provider :none)          ; Use Corfu instead of company
  (lsp-idle-delay 0.0)                     ; Debounce timer for after-change-function
  (lsp-log-io nil)                         ; Disable for performance
  (lsp-keep-workspace-alive nil)           ; Close LSP server when buffers are closed
  (lsp-enable-file-watchers nil)           ; Disable file watchers for performance
  (lsp-diagnostics-clean-after-change t)
  (lsp-debounce-full-sync-notifications nil)
  (lsp-debounce-full-sync-notifications-interval 0.0)

  ;; UI and features
  (lsp-keymap-prefix "C-c l")              ; LSP command prefix
  (lsp-eldoc-enable-hover t)               ; Enable hover documentation
  (lsp-signature-render-documentation nil) ; Disable to reduce noise
  (lsp-signature-doc-lines 1)              ; Limit signature lines
  (lsp-headerline-breadcrumb-enable nil)

  ;; Diagnostics
  (lsp-diagnostics-provider :flycheck)
  (lsp-diagnostics-clean-after-change t)
  (lsp--get-buffer-diagnostics)

  ;; Completion settings
  (lsp-completion-enable t)
  (lsp-completion-enable-additional-text-edit t)
  (lsp-enable-snippet t)
  (lsp-completion-show-kind t)

  ;; UI elements
                                        ;    (lsp-headerline-breadcrumb-enable t)
  (lsp-headerline-breadcrumb-enable-diagnostics t)
  (lsp-modeline-code-actions-enable t)
  (lsp-modeline-diagnostics-enable t)
  (lsp-modeline-workspace-status-enable t)

  ;; Semantic tokens (let tree-sitter handle syntax highlighting)
  (lsp-semantic-tokens-enable t)
  (lsp-enable-symbol-highlighting t)
  (lsp-lens-enable nil)

  :config
  ;; Fix orderless completion with lsp-mode
  (add-hook 'lsp-completion-mode-hook
            (lambda ()
              (setq-local completion-category-defaults
                          (assoc-delete-all 'lsp-capf completion-category-defaults))))
  :bind (:map lsp-mode-map
              ("C-c l r" . lsp-rename)
              ("C-c l a" . lsp-execute-code-action)
              ("C-c l f" . lsp-format-buffer)
              ("C-c l o" . lsp-organize-imports)
              ("C-c l d" . lsp-find-declaration)
              ("C-c l i" . lsp-find-implementation)
              ("C-c l t" . lsp-find-type-definition)
              ("C-c l s" . lsp-signature-activate)
              ("C-c l h" . lsp-describe-thing-at-point)))
#+end_src

** COMMENT LSP UI
#+begin_src elisp
;; LSP UI for additional features
(use-package lsp-ui
  :ensure t
  :after lsp-mode
  :custom
  ;; Documentation
  (lsp-ui-doc-enable nil)
  (lsp-ui-doc-show-with-cursor t)        ; Don't show doc on cursor hover
  (lsp-ui-doc-show-with-mouse nil)         ; Don't show doc on mouse hover
  (lsp-ui-doc-position 'at-point)          ; Show doc at point
  (lsp-ui-doc-include-signature t)         ; Include signature in doc
  (lsp-ui-doc-max-width 120)
  (lsp-ui-doc-max-height 30)

  ;; Sideline
  (lsp-ui-sideline-enable t)
  (lsp-ui-sideline-show-hover t)
  (lsp-ui-sideline-show-diagnostics t)
  (lsp-ui-sideline-show-code-actions t)
  (lsp-ui-sideline-diagnostic-max-lines 10)

  ;; Peek
  (lsp-ui-peek-enable t)
  (lsp-ui-peek-always-show t)
  (lsp-ui-peek-peek-height 30)
  (lsp-ui-peek-list-width 50)

  (lsp-ui-doc-delay 0.0)
  (lsp-ui-doc-max-width 100)
  (lsp-ui-doc-max-height 30)
  (lsp-ui-doc-position 'at-point)
  (lsp-ui-doc-border "white")
  (lsp-ui-doc-include-signature t)

  ;; Imenu
  (lsp-ui-imenu-enable t)
  (lsp-ui-imenu-kind-position 'top)

  :bind (:map lsp-mode-map
              ("C-c C-d" . lsp-ui-doc-glance)
              ("C-c C-p" . lsp-ui-peek-find-definitions)
              ("C-c C-r" . lsp-ui-peek-find-references)
              ("C-c C-i" . lsp-ui-imenu)))
#+end_src

** Flycheck
#+begin_src elisp
(use-package flycheck
  :ensure t
  :hook ((lsp-mode . flycheck-mode)
         (prog-mode . flycheck-mode))
  :custom
  (global-flycheck-mode))

(with-eval-after-load 'flycheck
  (setq flycheck-mode-line
        '(:eval
          (pcase flycheck-last-status-change
            (`finished (if flycheck-current-errors
                           (let ((count (let-alist (flycheck-count-errors flycheck-current-errors)
                                          (+ (or .error 0) (or .warning 0)))))
                             (concat
                              (all-the-icons-faicon "exclamation-triangle" :face 'error)
                              (format " %d" count)))
                         (concat (all-the-icons-faicon "check" :face 'success) " OK")))
            (`running (all-the-icons-faicon "spinner" :face 'warning))
            (`no-checker (all-the-icons-faicon "question" :face 'warning))
            (`not-checked (all-the-icons-faicon "ban" :face 'warning))
            (`errored (all-the-icons-faicon "times-circle" :face 'error))
            (`interrupted (all-the-icons-faicon "pause" :face 'warning))
            (_ (all-the-icons-faicon "question" :face 'warning))))))
#+end_src

* Modeline
#+begin_src elisp
(use-package doom-modeline
  :ensure t
  :hook (elpaca-after-init . doom-modeline-mode)
  :custom
  ;; Core appearance
  (doom-modeline-height 40)
  (doom-modeline-bar-width 3)
  (doom-modeline-window-width-limit 120)
  (doom-modeline-project-detection 'auto)
  (setq doom-modeline-height 20))

(with-eval-after-load 'doom-modeline
  (when (string= (system-name) "WarMachine")
    (setq doom-modeline-height 40))

  (when (string= (system-name) "Tiffany")
    (setq doom-modeline-height 20)
    (display-battery-mode -1)))

;;   ;; Icons and styling
;;   (doom-modeline-icon t)
;;   (doom-modeline-major-mode-icon t)
;;   (doom-modeline-major-mode-color-icon t)
;;   (doom-modeline-buffer-state-icon t)
;;   (doom-modeline-buffer-modification-icon t)
;;   (doom-modeline-unicode-fallback t)

;;   ;; Buffer information
;;   (doom-modeline-buffer-name t)
;;   (doom-modeline-highlight-modified-buffer-name t)
;;   (doom-modeline-buffer-file-name-style 'auto)

;;   ;; Git integration
;;   (doom-modeline-vcs-max-length 20)
;;   (doom-modeline-enable-word-count nil)

;;   ;; LSP integration
;;   (doom-modeline-lsp t)
;;   (doom-modeline-lsp-icon t)

;;   ;; Flycheck integration
;;   (doom-modeline-checker-simple-format t)

;;   ;; Workspace and environment
;;   (doom-modeline-workspace-name t)
;;   (doom-modeline-persp-name t)
;;   (doom-modeline-env-version t)
;;   (doom-modeline-env-enable-python t)
;;   (doom-modeline-env-enable-ruby t)
;;   (doom-modeline-env-enable-perl t)
;;   (doom-modeline-env-enable-go t)
;;   (doom-modeline-env-enable-elixir t)
;;   (doom-modeline-env-enable-rust t)

;;   ;; System monitoring
;;   (doom-modeline-battery t)
;;   (doom-modeline-time t)
;;   (doom-modeline-display-misc-in-all-mode-lines t)

;;   ;; Modal editing support
;;   (doom-modeline-modal-icon t)
;;   (doom-modeline-modal-modern-icon t))

;; ;; Custom extensions deferred until doom-modeline is loaded
;; (with-eval-after-load 'doom-modeline
;;   (defun my/doom-modeline-treesit-indicator ()
;;     "Show tree-sitter status in modeline."
;;     (when (and (fboundp 'treesit-available-p)
;;                (treesit-available-p)
;;                (treesit-language-at (point)))
;;       (format " TS[%s]" (treesit-language-at (point)))))

;;   (doom-modeline-def-segment my-treesit
;;     (my/doom-modeline-treesit-indicator))

;;   (doom-modeline-def-segment my-lsp-enhanced
;;     (when (and (bound-and-true-p eglot--managed-mode)
;;                (eglot--workspace))
;;       (let ((folders (length (eglot-workspace-folders (eglot--workspace)))))
;;         (format " E[%d]" folders))))

;;   ;; fall back to flymake diagnostics count if eglot is not active
;;   (doom-modeline-def-segment my-flymake-diagnostics
;;     (when (bound-and-true-p flymake-mode)
;;       (let ((err-count (let-alist (flymake--state flymake-diagnostics)
;;                          (length .error))))
;;         (when (> err-count 0)
;;           (format " F[%d]" err-count)))))

;;   (doom-modeline-def-modeline 'my-main
;;     '(bar workspace-name window-number modals matches follow buffer-info remote-host buffer-position word-count parrot selection-info)
;;     '(compilation objed-state misc-info persp-name battery grip irc mu4e gnus github debug lsp minor-modes input-method indent-info buffer-encoding major-mode process vcs my-treesit my-lsp-enhanced my-flymake-diagnostics time))

;;   (add-hook 'doom-modeline-mode-hook
;;             (lambda () (doom-modeline-set-modeline 'my-main 'default)))
#+end_src

** COMMENT Catppuccin-Theme with modus
#+begin_src elisp
(use-package modus-themes
  :ensure t
  :defer t
  :custom
  (modus-themes-italic-constructs t)
  (modus-themes-bold-constructs t)
  (modus-themes-mixed-fonts nil)
  (modus-themes-prompts '(bold intense))
  (modus-themes-common-palette-overrides
   `((accent-0 "#89b4fa")
     (accent-1 "#89dceb")
     (bg-active bg-main)
     (bg-added "#364144")
     (bg-added-refine "#4A5457")
     (bg-changed "#3e4b6c")
     (bg-changed-refine "#515D7B")
     (bg-completion "#45475a")
     (bg-completion-match-0 "#1e1e2e")
     (bg-completion-match-1 "#1e1e2e")
     (bg-completion-match-2 "#1e1e2e")
     (bg-completion-match-3 "#1e1e2e")
     (bg-hl-line "#2a2b3d")
     (bg-hover-secondary "#585b70")
     (bg-line-number-active unspecified)
     (bg-line-number-inactive "#1e1e2e")
     (bg-main "#1e1e2e")
     (bg-mark-delete "#443245")
     (bg-mark-select "#3e4b6c")
     (bg-mode-line-active "#181825")
     (bg-mode-line-inactive "#181825")
     (bg-prominent-err "#443245")
     (bg-prompt unspecified)
     (bg-prose-block-contents "#313244")
     (bg-prose-block-delimiter bg-prose-block-contents)
     (bg-region "#585b70")
     (bg-removed "#443245")
     (bg-removed-refine "#574658")
     (bg-tab-bar      "#1e1e2e")
     (bg-tab-current  bg-main)
     (bg-tab-other    "#1e1e2e")
     (border-mode-line-active nil)
     (border-mode-line-inactive nil)
     (builtin "#89b4fa")
     (comment "#9399b2")
     (constant  "#f38ba8")
     (cursor  "#f5e0dc")
     (date-weekday "#89b4fa")
     (date-weekend "#fab387")
     (docstring "#a6adc8")
     (err     "#f38ba8")
     (fg-active fg-main)
     (fg-completion "#cdd6f4")
     (fg-completion-match-0 "#89b4fa")
     (fg-completion-match-1 "#f38ba8")
     (fg-completion-match-2 "#a6e3a1")
     (fg-completion-match-3 "#fab387")
     (fg-heading-0 "#f38ba8")
     (fg-heading-1 "#fab387")
     (fg-heading-2 "#f9e2af")
     (fg-heading-3 "#a6e3a1")
     (fg-heading-4 "#74c7ec")
     (fg-line-number-active "#b4befe")
     (fg-line-number-inactive "#7f849c")
     (fg-link  "#89b4fa")
     (fg-main "#cdd6f4")
     (fg-mark-delete "#f38ba8")
     (fg-mark-select "#89b4fa")
     (fg-mode-line-active "#bac2de")
     (fg-mode-line-inactive "#585b70")
     (fg-prominent-err "#f38ba8")
     (fg-prompt "#cba6f7")
     (fg-prose-block-delimiter "#9399b2")
     (fg-prose-verbatim "#a6e3a1")
     (fg-region "#cdd6f4")
     (fnname    "#89b4fa")
     (fringe "#1e1e2e")
     (identifier "#cba6f7")
     (info    "#94e2d5")
     (keyword   "#cba6f7")
     (keyword "#cba6f7")
     (name "#89b4fa")
     (number "#fab387")
     (property "#89b4fa")
     (string "#a6e3a1")
     (type      "#f9e2af")
     (variable  "#fab387")
     (warning "#f9e2af")))
  :config
  (modus-themes-with-colors
   (custom-set-faces
    `(change-log-acknowledgment ((,c :foreground "#b4befe")))
    `(change-log-date ((,c :foreground "#a6e3a1")))
    `(change-log-name ((,c :foreground "#fab387")))
    `(diff-context ((,c :foreground "#89b4fa")))
    `(diff-file-header ((,c :foreground "#f5c2e7")))
    `(diff-header ((,c :foreground "#89b4fa")))
    `(diff-hunk-header ((,c :foreground "#fab387")))
    `(gnus-button ((,c :foreground "#8aadf4")))
    `(gnus-group-mail-3 ((,c :foreground "#8aadf4")))
    `(gnus-group-mail-3-empty ((,c :foreground "#8aadf4")))
    `(gnus-header-content ((,c :foreground "#7dc4e4")))
    `(gnus-header-from ((,c :foreground "#cba6f7")))
    `(gnus-header-name ((,c :foreground "#a6e3a1")))
    `(gnus-header-subject ((,c :foreground "#8aadf4")))
    `(log-view-message ((,c :foreground "#b4befe")))
    `(match ((,c :background "#3e5768" :foreground "#cdd6f5")))
    `(modus-themes-search-current ((,c :background "#f38ba8" :foreground "#11111b" ))) ;; :foreground "#cdd6f4" -- Catppuccin default, not that visible...
    `(modus-themes-search-lazy ((,c :background "#3e5768" :foreground "#cdd6f5")))     ;; :foreground "#cdd6f4" :background "#94e2d5" -- Catppuccin default, not that visible...
    `(newsticker-extra-face ((,c :foreground "#9399b2" :height 0.8 :slant italic)))
    `(newsticker-feed-face ((,c :foreground "#f38ba8" :height 1.2 :weight bold)))
    `(newsticker-treeview-face ((,c :foreground "#cdd6f4")))
    `(newsticker-treeview-selection-face ((,c :background "#3e5768" :foreground "#cdd6f5")))
    `(tab-bar ((,c :background "#1e1e2e" :foreground "#bac2de")))
    `(tab-bar-tab ((,c :background "#1e1e2e" :underline t)))
    `(tab-bar-tab-group-current ((,c :background "#1e1e2e" :foreground "#bac2de" :underline t)))
    `(tab-bar-tab-group-inactive ((,c :background "#1e1e2e" :foreground "#9399b2"))))
   `(tab-bar-tab-inactive ((,c :background "#1e1e2e" :foreground "#a6adc8")))
   `(vc-dir-file ((,c :foreground "#89b4fa")))
   `(vc-dir-header-value ((,c :foreground "#b4befe"))))
  :init
  (load-theme 'modus-vivendi t))
#+end_src

** Chess
#+begin_src elisp
(use-package chess
  :ensure t
  :commands (chess))
#+end_src

** Disable line number with large files
#+begin_src elisp
(defun my-large-file-setup ()
  "Optimize Emacs for large files."
  (when (> (buffer-size) (* 1024 1024)) ; larger than 1MB
    (fundamental-mode)
    (auto-save-mode -1)
    (buffer-disable-undo)
    (setq bidi-display-reordering nil)
    (jit-lock-mode -1)
    (font-lock-mode -1)
    (longlines-mode -1)))

(add-hook 'find-file-hook 'my-large-file-setup)
#+end_src

** Eglot
#+begin_src elisp
(use-package eglot
  :ensure nil
  :hook ((c-ts-mode c++-ts-mode python-ts-mode bash--tsmode lua-ts-mode sh-mode asm-mode) . eglot-ensure)
  :custom
  ;; CRITICAL: Disable flymake integration - we use flycheck exclusively
  (eglot-stay-out-of 'flymake)
  (flymake-mode nil)
  (eglot-sync-connect nil)

  ;; Enhanced LSP communication settings
  (eglot-events-buffer-size 0)            ; Disable events buffer for performance
  (eglot-autoshutdown t)                  ; Auto-shutdown unused servers
  (eglot-sync-connect nil)                ; Async connection for responsiveness
  (eglot-extend-to-xref t)                ; Enhanced cross-references
  (eglot-report-progress nil)            ; Disable progress reports for focus
  (eglot-send-changes-idle-time 0.5)

  :bind (:map eglot-mode-map
              ("C-c l r" . eglot-rename)
              ("C-c l a" . eglot-code-actions)
              ("C-c l f" . eglot-format)
              ("C-c l d" . eglot-find-declaration)
              ("C-c l i" . eglot-find-implementation)
              ("C-c l t" . eglot-find-typeDefinition)))

;; Configure server programs after eglot is loaded, outside use-package
;; Keep non-custom/config logic outside use-package
(with-eval-after-load 'eglot-ensure
  (add-to-list 'eglot-stay-out-of 'flymake)
  (add-to-list 'eglot-server-programs
               '(c-ts-mode . ("clangd" "--offset-encoding=utf-16" "ccls")))
  (add-to-list 'eglot-server-programs
               '(c++-ts-mode . ("clangd" "--offset-encoding=utf-16" "ccls")))
  (add-to-list 'eglot-server-programs
               '(python-ts-mode . ("python-flake8")))
  (add-to-list 'eglot-server-programs
               '(lua-ts-mode . ("lua-language-server")))
  (add-to-list 'eglot-server-programs
               '(bash-ts-mode . ("bash-language-server" "start" "spellcheck"))))


;; Add eglot hooks for the relevant Tree-sitter modes (if not covered by prog-mode)
                                        ;(dolist (mode '(python-ts-mode c-ts-mode c++-ts-mode bash-ts-mode lua-ts-mode))
                                        ; (add-hook (intern (format "%s-hook" mode)) #'eglot-ensure)
#+end_src

** Consult-eglot
#+begin_src elisp
(use-package consult-eglot
  :ensure t
  :after (eglot consult)
  :functions (consult-eglot-symbols)
  :bind (:map eglot-mode-map
              ("C-c C-." . consult-eglot-symbols)))
#+end_src


** COMMENT Flymake
#+begin_src elisp
(use-package flymake
  :ensure nil
  :hook (lsp-mode . flymake-mode)
  :custom
  (flymake-indicator-type 'margins)
  (flymake-margin-indicators-string
   `((error ,(propertize "┃"
                         'face '(:inherit compilation-error
                                          'display '((margin left-margin)))
                         compilation-error)

            (warning ,(propertize "┃"
                                  'face '(:inherit compilation-warning
                                                   'display '((margin left-margin)))
                                  compilation-warning)

                     (note ,(propertize "┃"
                                        'face '(:inherit compilation-info
                                                         'display '((margin left-margin)))
                                        compilation-info)))))))
#+end_src

** COMMENT Doom Theme
#+begin_src elisp
(use-package doom-themes
  :ensure t
  :custom
  (doom-themes-enable-bold t)
  (doom-themes-org-config)
  (doom-theme-enable-italic t))


(setq custom-safe-themes t)
(add-to-list 'custom-theme-load-path (expand-file-name "straight/build/doom-themes/" user-emacs-directory))
(load-theme 'doom-1337 t)
#+end_src

** COMMENT Eldoc
#+begin_src elisp
(use-package eldoc
  :ensure nil
  :custom
  (eldoc-echo-area-use-multiline-p 3)
  (eldoc-echo-area-display-truncation-message nil)
  (eldoc-documentation-strategy 'eldoc-documentation-compose-eagerly)
  :config
  (add-hook 'prog-mode-hook #'eldoc-mode)

  ;; Better integration with lsp-mode
  (add-hook 'lsp-managed-mode-hook
            (lambda ()
              (setq eldoc-documentation-functions
                    (cons #'lsp-eldoc-function
                          (remove #'lsp-eldoc-function eldoc-documentation-functions))))))
#+end_src

** Format-all
#+begin_src elisp
(use-package format-all
  :ensure t
  :commands (format-all-mode)
  :hook (prog-mode . format-all-mode) ;; Lazy enable format-all in programming modes
  :bind
  ("C-c f" . format-all-buffer)
  :custom
  (format-all-formatters
   '(("C"       clang-format)
     ("Python"  black)
     ("JavaScript" prettier)
     (emacs-lisp-mode . "elisp-autofmt")
     ("Shell"   (shfmt "-i" "4" "-ci")))))

;; Setup additional hooks and buffer-local overrides lazily only after format-all loads
(with-eval-after-load 'format-all
  ;; Always ensure a formatter is selected when format-all-mode is active
  (add-hook 'format-all-mode-hook #'format-all-ensure-formatter)

  ;; Language-specific buffer-local customizations
  (add-hook 'python-mode-hook
            (lambda ()
              (setq-local format-all-formatters '(("Python" black)))))

  (add-hook 'c-mode-hook
            (lambda ()
              (setq-local format-all-formatters '(("C" clang-format)))))

  (add-hook 'java-mode-hook
            (lambda ()
              (setq-local format-all-formatters '(("Java" (astyle "--mode=java"))))))
  (add-hook 'before-save-hook 'format-all-buffer))
#+end_src

** COMMENT Lsp bridge
#+begin_src elisp
(use-package lsp-bridge
  :ensure (lsp-bridge
           :type git
           :host github
           :repo "manateelazycat/lsp-bridge"
           :files ("*"))
  :defer 1
  :commands (global-lsp-bridge-mode lsp-bridge-mode)
  :custom
  (acm-enable-codeium nil)
  (acm-enable-tabnine nil)
  (acm-enable-yas nil)
  (acm-enable-quick-access t)
  (lsp-bridge-enable-hover-diagnostic t)
  (lsp-bridge-python-lsp-server "pyright")
  (lsp-bridge-c-lsp-server "ccls")
  :bind (("M-." . lsp-bridge-find-def)
         ("M-," . lsp-bridge-find-def-return)
         ("M-i" . lsp-bridge-popup-documentation)
         ("C-M-." . lsp-bridge-peek)
         :map lsp-bridge-ref-mode-map
         ("n" . lsp-bridge-ref-jump-next-keyword)
         ("p" . lsp-bridge-ref-jump-prev-keyword)
         ("M-n" . lsp-bridge-ref-jump-next-file)
         ("M-p" . lsp-bridge-ref-jump-prev-file) ;
         ("C-x C-q" . lsp-bridge-ref-switch-to-edit-mode)
         :map lsp-bridge-ref-mode-edit-map
         ("C-x C-q" . lsp-bridge-ref-apply-changed)
         ("C-x C-s" . lsp-bridge-ref-apply-changed)
         ("C-c C-k" . lsp-bridge-ref-quit)
         ("M-n" . lsp-bridge-ref-jump-next-file)
         ("M-p" . lsp-bridge-ref-jump-prev-file)
         :map acm-mode-map
         ([remap next-line] . nil)
         ([remap previous-line] . nil))
  :config
  (global-lsp-bridge-mode))
#+end_src

* Code review

** Hexl-mode
#+begin_src elisp
(use-package hexl
  :ensure nil
  :hook (find-file . (lambda ()
                       (let ((extensions '("out" "o" "so" "dll" "exe" ""))) ;; add relevant extensions
                         (when (and buffer-file-name
                                    (member (file-name-extension buffer-file-name)
                                            extensions))
                           (when (yes-or-no-p (format "Open file %s in hexl-mode? " (file-name-nondirectory buffer-file-name)))
                             (hexl-mode)))))))
#+end_src

** Disaster
#+begin_src elisp
(use-package disaster
  :ensure (:host github :repo "jart/disaster")
  :commands (disaster)
  :custom
  ;; If you prefer viewing assembly code in `nasm-mode` instead of `asm-mode`
  (disaster-assembly-mode #'nasm-mode)
  (map! :localleader
        :map (c++-mode-map c-mode-map fortran-mode-map)
        :desc "Disaster" "d" #'disaster))
#+end_src

** Speed type
#+begin_src elisp
(use-package speed-type
  :ensure t
  :commands (speed-type))
#+end_src

** ibuffer
#+begin_src elisp
(use-package ibuffer
  :ensure nil
  :bind ("C-x C-b" . ibuffer)
  :custom
  (ibuffer-formats
   '((mark modified read-only locked " "
           (name 35 35 :left :elide)
           " "
           (size 9 -1 :right)
           " "
           (mode 16 16 :left :elide)
           " " filename-and-process)
     (mark " "
           (name 16 -1)
           " " filename))))

(use-package ibuffer-vc
  :commands (ibuffer-vc-set-filter-groups-by-vc-root)
  :custom
  (ibuffer-vc-skip-if-remote nil))

;; Add ibuffer-vc grouping on ibuffer mode hook lazily, after package is loaded
(with-eval-after-load 'ibuffer-vc
  (add-hook 'ibuffer-mode-hook #'ibuffer-vc-set-filter-groups-by-vc-root))
#+end_src

** Pdf-Tools
#+begin_src elisp
(use-package pdf-tools
  :commands (pdf-view-mode pdf-tools-install)
  :mode ("\\.pdf\\'" . pdf-view-mode)
  :hook (pdf-view-mode . pdf-tools-enable-minor-modes))

(defun pdf-tools-enable-minor-modes ()
  "Enable useful modes for PDF viewing lazily."
  (pdf-tools-install)
  (display-line-numbers-mode -1)
  (visual-line-mode 1))
#+end_src

** Winner mode
#+begin_src elisp
(use-package winner
  :ensure nil
  :custom
  (winner-boring-buffers
   '("*Completions*"
     "*Compile-Log*"
     "*Fuzzy Completions*"
     "*Help*"
     "*Buffer List*"
     "*Ibuffer*"))
  :config
  (winner-mode 1))
#+end_src

** Vundo
#+begin_src elisp
(use-package vundo
  :ensure t
  :bind ("C-x u" . vundo)
  :commands (vundo-diff-mode)
  :custom
  (vundo-mode)
  (diff-switches "-u --color=never")
  (vundo-glyph-alist vundo-unicode-symbols)
  (vundo-compact-display t)
  (vundo-window-max-height 8)
  (vundo-glyph-alist vundo-unicode-symbols))
#+end_src

** Discover My Major
#+begin_src elisp
(use-package discover-my-major
  :ensure t
  :bind ("C-h C-m" . discover-my-major))
#+end_src

** Battery
#+begin_src elisp
(use-package battery
  :ensure nil
  :custom
  (display-time-mode 1)
  (display-battery-mode 1))
#+end_src

** COMMENT Simple dark theme
#+begin_src elisp
(use-package simple-dark
  :ensure (:host github :repo "tek256/simple-dark" :main "simple-dark-theme.el")
  :hook  (emacs-startup . (lambda () (load-theme 'simple-dark t))))
#+end_src

** COMMENT mini-midnight
#+begin_src elisp
(use-package mini-midnight
  :ensure (:host github :repo "d4lj337/mini-midnight" :main "mini-midnight-theme.el")
  :hook  (emacs-startup . (lambda () (load-theme 'mini-midnight t))))
#+end_src

** mini-carbon
#+begin_src elisp
(use-package mini-carbon
  :ensure (:host github :repo "d4lj337/mini-carbon" :main "mini-carbon-theme.el")
  :hook  (emacs-startup . (lambda () (load-theme 'mini-carbon t))))
#+end_src

** mini-essays
#+begin_src elisp
(use-package mini-essays
  :ensure (:host github :repo "D4lj337/Mini-essays" :files ("*.el"))
  :hook (org-mode . mini-essays-setup)
  :custom
  (mini-essays-max-chars 3000))
                                        ;  (mini-essays-fill-column 100))

;; Setup auto-insert separately
(with-eval-after-load 'mini-essays
  (mini-essays-setup-auto-insert))
#+end_src

** Mini-Dashboard
#+begin_src elisp
(use-package mini-dashboard
  :ensure (:host github :repo "d4lj337/mini-dashboard" :main "mini-dashboard.el")
  :init
  (mini-dashboard-setup-initial-buffer)
  :bind (("C-c d" . mini-dashboard-open)
         :map mini-dashboard-mode-map
         ("q" . quit-window)
         ("r" . mini-dashboard-refresh))
  :custom
  (mini-dashboard--render 'center)
  (mini-dashboard-text "Welcome, Hacker!\n\nReady to bend reality with parentheses?")
                                        ;  (mini-dashboard-footer "\"The only way to learn a new programming language is by writing programs in it.\" - Dennis Ritchie")
  (mini-dashboard-footer #'minimal-dashboard--random-stoic-quote)
  (mini-dashboard-ascii-art "
    ███████╗███╗   ███╗ █████╗  ██████╗███████╗
    ██╔════╝████╗ ████║██╔══██╗██╔════╝██╔════╝
    █████╗  ██╔████╔██║███████║██║     ███████╗
    ██╔══╝  ██║╚██╔╝██║██╔══██║██║     ╚════██║
    ███████╗██║ ╚═╝ ██║██║  ██║╚██████╗███████║
    ╚══════╝╚═╝     ╚═╝╚═╝  ╚═╝ ╚═════╝╚══════╝
")

  ;; (mini-dashboard-ascii-art "
  ;;    ,           ,
  ;;   /             \\
  ;;  ((__-^^-,-^^-__))
  ;;   `-_---' `---_-'
  ;;    `--|o` 'o|--'
  ;;       \\  `  /
  ;;        ): :(
  ;;        :o_o:
  ;;        \"-\"")

  ;; (mini-dashboard-text
  ;;     (lambda ()
  ;;       (format "Welcome, %s\n\nEmacs started in %s"
  ;;               user-login-name
  ;;               (emacs-init-time))))
  (mini-dashboard-footer
   (lambda ()
     (format "Emacs %s • %s • Load: %.2f"
             emacs-version
             (format-time-string "%H:%M")
             (car (load-average)))))
  (mini-dashboard-modeline-shown nil)
  (mini-dashboard-enable-resize-handling t)
  (mini-dashboard-vertical-padding 5)
  :config
  (mini-dashboard-setup-initial-buffer))
#+end_src

** Ellama
#+begin_src elisp
(use-package ellama
  :ensure t
  :bind ("C-c o" . ellama)
  :config
  (setopt ellama-provider
          (make-llm-ollama
           :chat-model "tinyllama"
           :embedding-model "nomic-embed-text")))
#+end_src

**  System App Launcher
#+begin_src elisp
(use-package app-launcher
  :ensure (:host github :repo "SebastienWae/app-launcher")
  :bind ("C-c p" . app-launcher-run-app))
#+end_src

** Hacker News
#+begin_src elisp
(use-package hackernews
  :ensure t
  :custom
  (hackernews-default-feed 'top) ;; can be 'ask, 'best, 'new, 'show
  ;; Make Hacker News buffers open in the same window
  (display-buffer-alist
   '((".*\\*hackernews.*\\*" display-buffer-same-window)))

  :bind
  (("C-c h" . hackernews)               ;; open top stories
   ("C-c H a" . hackernews-ask-stories) ;; open Ask HN
   ("C-c H b" . hackernews-best-stories)
   ("C-c H n" . hackernews-new-stories)
   ("C-c H s" . hackernews-show-stories)
   ("C-c H j" . hackernews-job-stories))

  :hook
  (hackernews-mode . visual-line-mode))
#+end_src
